<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카드 상세 정보</title>
    <link rel="stylesheet" th:href="@{/css/finance.css}">
</head>
<body>
<div class="container">
    <header class="header">
        <div class="header-left">
            <a href="/dashboard" class="btn-back">← 뒤로가기</a>
            <h1>카드 상세 정보</h1>
        </div>
        <div class="user-info">
            <span th:text="${username}">사용자</span>
        </div>
    </header>

    <div class="content">
        <div class="detail-container">
            <!-- 읽기 모드 -->
            <div id="viewMode" class="detail-view">
                <div class="detail-card">
                    <div class="card-header">
                        <div class="card-color" th:style="'background-color: ' + ${card.color}"></div>
                        <h2 th:text="${card.cardName}">카드명</h2>
                        <span th:if="${card.isDefault}" class="badge-default">기본</span>
                    </div>

                    <div class="detail-info">
                        <div class="info-row">
                            <label>카드사</label>
                            <span th:text="${card.cardCompany}">카드사</span>
                        </div>
                        <div class="info-row">
                            <label>카드번호</label>
                            <span th:text="${card.cardNumber}">카드번호</span>
                        </div>
                        <div class="info-row">
                            <label>카드 유형</label>
                            <span th:text="${card.cardType}">카드 유형</span>
                        </div>
                        <div class="info-row" th:if="${card.cardType.toString() == 'DEBIT'}">
                            <label>잔액</label>
                            <span class="balance" th:text="${#numbers.formatDecimal(card.balance, 0, 'COMMA', 0, 'POINT')} + '원'">0원</span>
                        </div>
                        <div class="info-row" th:if="${card.cardType.toString() == 'CREDIT'}">
                            <label>신용 한도</label>
                            <span class="balance" th:text="${#numbers.formatDecimal(card.creditLimit, 0, 'COMMA', 0, 'POINT')} + '원'">0원</span>
                        </div>
                        <div class="info-row">
                            <label>색상</label>
                            <div class="color-preview" th:style="'background-color: ' + ${card.color}"></div>
                        </div>
                        <div class="info-row">
                            <label>활성 상태</label>
                            <span th:text="${card.isActive} ? '활성' : '비활성'">활성</span>
                        </div>
                    </div>

                    <div class="detail-actions">
                        <button onclick="enterEditMode()" class="btn-primary">수정하기</button>
                        <button th:if="!${card.isDefault}" th:onclick="'setAsDefault(' + ${card.id} + ')'" class="btn-secondary">기본 카드로 설정</button>
                        <button th:onclick="'deleteCard(' + ${card.id} + ')'" class="btn-danger">카드 삭제</button>
                    </div>
                </div>
            </div>

            <!-- 수정 모드 -->
            <div id="editMode" class="detail-edit" style="display: none;">
                <form id="editForm" class="edit-form">
                    <input type="hidden" id="cardId" th:value="${card.id}">
                    <input type="hidden" id="currentCardType" th:value="${card.cardType}">

                    <div class="form-group">
                        <label for="cardName">카드명 *</label>
                        <input type="text" id="cardName" th:value="${card.cardName}" required>
                    </div>

                    <div class="form-group">
                        <label for="cardCompany">카드사 *</label>
                        <input type="text" id="cardCompany" th:value="${card.cardCompany}" required>
                    </div>

                    <div class="form-group">
                        <label for="cardNumber">카드번호 *</label>
                        <input type="text" id="cardNumber" th:value="${card.cardNumber}" readonly>
                    </div>

                    <div class="form-group">
                        <label for="cardType">카드 유형 *</label>
                        <select id="cardType" required onchange="toggleCardFields()">
                            <option value="DEBIT" th:selected="${card.cardType.toString() == 'DEBIT'}">체크카드</option>
                            <option value="CREDIT" th:selected="${card.cardType.toString() == 'CREDIT'}">신용카드</option>
                        </select>
                    </div>

                    <!-- 체크카드 필드 -->
                    <div id="debitFields" style="display: none;">
                        <div class="form-group">
                            <label for="balance">잔액 *</label>
                            <input type="number" id="balance" th:value="${card.balance}" min="0" step="1000">
                        </div>
                    </div>

                    <!-- 신용카드 필드 -->
                    <div id="creditFields" style="display: none;">
                        <div class="form-group">
                            <label for="creditLimit">신용 한도 *</label>
                            <input type="number" id="creditLimit" th:value="${card.creditLimit}" min="0" step="10000">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="color">색상</label>
                        <input type="color" id="color" th:value="${card.color}">
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="isActive" th:checked="${card.isActive}">
                            활성 상태
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">저장하기</button>
                        <button type="button" onclick="cancelEdit()" class="btn-secondary">취소</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const cardData = /*[[${card}]]*/ {};

    // 페이지 로드 시 카드 타입에 따라 필드 표시
    window.addEventListener('DOMContentLoaded', function() {
        toggleCardFields();
    });

    function enterEditMode() {
        document.getElementById('viewMode').style.display = 'none';
        document.getElementById('editMode').style.display = 'block';
        toggleCardFields();
    }

    function cancelEdit() {
        document.getElementById('editMode').style.display = 'none';
        document.getElementById('viewMode').style.display = 'block';
    }

    function toggleCardFields() {
        const cardType = document.getElementById('cardType').value;
        const debitFields = document.getElementById('debitFields');
        const creditFields = document.getElementById('creditFields');

        if (cardType === 'DEBIT') {
            debitFields.style.display = 'block';
            creditFields.style.display = 'none';
        } else {
            debitFields.style.display = 'none';
            creditFields.style.display = 'block';
        }
    }

    async function setAsDefault(cardId) {
        if (!confirm('이 카드를 기본 카드로 설정하시겠습니까?')) {
            return;
        }

        try {
            const response = await fetch(`/api/v1/cards/${cardId}/default`, {
                method: 'PATCH',
                credentials: 'include'
            });

            if (response.ok) {
                alert('기본 카드로 설정되었습니다.');
                location.reload();
            } else {
                const error = await response.json();
                alert('설정 실패: ' + (error.message || '알 수 없는 오류'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('기본 카드 설정 중 오류가 발생했습니다.');
        }
    }

    async function deleteCard(cardId) {
        if (!confirm('정말 이 카드를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
            return;
        }

        try {
            const response = await fetch(`/api/v1/cards/${cardId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok || response.status === 204) {
                alert('카드가 삭제되었습니다.');
                window.location.href = '/dashboard';
            } else {
                const error = await response.json();
                alert('삭제 실패: ' + (error.message || '알 수 없는 오류'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('카드 삭제 중 오류가 발생했습니다.');
        }
    }

    // 폼 제출 처리
    document.getElementById('editForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const cardId = document.getElementById('cardId').value;
        const cardType = document.getElementById('cardType').value;

        const formData = {
            cardName: document.getElementById('cardName').value,
            cardCompany: document.getElementById('cardCompany').value,
            cardType: cardType,
            color: document.getElementById('color').value,
            isActive: document.getElementById('isActive').checked
        };

        // 카드 유형에 따라 추가 필드 포함
        if (cardType === 'DEBIT') {
            formData.balance = parseFloat(document.getElementById('balance').value) || 0;
        } else if (cardType === 'CREDIT') {
            formData.creditLimit = parseFloat(document.getElementById('creditLimit').value) || 0;
        }

        try {
            const response = await fetch(`/api/v1/cards/${cardId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData),
                credentials: 'include'
            });

            if (response.ok) {
                alert('카드 정보가 수정되었습니다.');
                location.reload();
            } else {
                const error = await response.json();
                alert('수정 실패: ' + (error.message || '알 수 없는 오류'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('카드 정보 수정 중 오류가 발생했습니다.');
        }
    });
</script>
</body>
</html>
