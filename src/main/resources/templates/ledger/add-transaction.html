<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>거래 추가</title>
    <link rel="stylesheet" th:href="@{/css/finance.css}">
</head>
<body>
<div class="container">
    <header class="header">
        <a href="/ledger" class="btn-back">← 돌아가기</a>
        <h1>거래 추가</h1>
    </header>

    <div class="content">
        <form id="addTransactionForm" class="form-container">
            <div class="form-group">
                <label for="type">거래 유형 <span class="required">*</span></label>
                <select id="type" name="type" required>
                    <option value="">선택하세요</option>
                    <option value="INCOME">수입</option>
                    <option value="EXPENSE">지출</option>
                </select>
            </div>

            <div class="form-group">
                <label for="amount">금액 <span class="required">*</span></label>
                <input type="number" id="amount" name="amount" placeholder="0" min="0" step="1000" required>
            </div>

            <div class="form-group">
                <label for="categoryId">카테고리 <span class="required">*</span></label>
                <select id="categoryId" name="categoryId" required>
                    <option value="">선택하세요</option>
                    <option th:each="cat : ${categories}"
                            th:value="${cat.id}"
                            th:text="${cat.name}"
                            th:attr="data-type=${cat.type}">카테고리</option>
                </select>
            </div>

            <div class="form-group">
                <label for="description">내역</label>
                <input type="text" id="description" name="description" placeholder="예) 월급, 식비 등">
            </div>

            <div class="form-group">
                <label for="transactionDate">거래일 <span class="required">*</span></label>
                <input type="date" id="transactionDate" name="transactionDate" required>
            </div>

            <div class="form-group">
                <label for="paymentMethod">결제 수단 <span class="required">*</span></label>
                <select id="paymentMethod" name="paymentMethod" required>
                    <option value="">선택하세요</option>
                    <option value="ACCOUNT">계좌</option>
                    <option value="CARD">카드</option>
                    <option value="CASH">현금</option>
                </select>
            </div>

            <div class="form-group" id="accountGroup" style="display: none;">
                <label for="accountId">계좌 선택 <span class="required">*</span></label>
                <select id="accountId" name="accountId">
                    <option value="">선택하세요</option>
                    <option th:each="acc : ${accounts}"
                            th:value="${acc.id}"
                            th:text="${acc.accountName}">계좌</option>
                </select>
            </div>

            <div class="form-group" id="cardGroup" style="display: none;">
                <label for="cardId">카드 선택 <span class="required">*</span></label>
                <select id="cardId" name="cardId">
                    <option value="">선택하세요</option>
                    <option th:each="card : ${cards}"
                            th:value="${card.id}"
                            th:text="${card.cardName}">카드</option>
                </select>
            </div>

            <div class="form-group">
                <label for="memo">메모</label>
                <textarea id="memo" name="memo" rows="3" placeholder="메모를 입력하세요"></textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="history.back()">취소</button>
                <button type="submit" class="btn-primary">추가</button>
            </div>
        </form>
    </div>
</div>

<script th:inline="javascript">
    // Set default date to today
    document.getElementById('transactionDate').valueAsDate = new Date();

    // Transaction type change handler - filter categories
    document.getElementById('type').addEventListener('change', function() {
        const selectedType = this.value;
        const categorySelect = document.getElementById('categoryId');
        const options = categorySelect.querySelectorAll('option');

        options.forEach(option => {
            if (option.value === '') {
                option.style.display = 'block';
            } else {
                const catType = option.getAttribute('data-type');
                option.style.display = (catType === selectedType || selectedType === '') ? 'block' : 'none';
            }
        });

        categorySelect.value = '';
    });

    // Payment method change handler - show/hide account/card selects
    document.getElementById('paymentMethod').addEventListener('change', function() {
        const method = this.value;
        const accountGroup = document.getElementById('accountGroup');
        const cardGroup = document.getElementById('cardGroup');
        const accountSelect = document.getElementById('accountId');
        const cardSelect = document.getElementById('cardId');

        if (method === 'ACCOUNT') {
            accountGroup.style.display = 'block';
            cardGroup.style.display = 'none';
            accountSelect.required = true;
            cardSelect.required = false;
            cardSelect.value = '';
        } else if (method === 'CARD') {
            accountGroup.style.display = 'none';
            cardGroup.style.display = 'block';
            accountSelect.required = false;
            cardSelect.required = true;
            accountSelect.value = '';
        } else {
            accountGroup.style.display = 'none';
            cardGroup.style.display = 'none';
            accountSelect.required = false;
            cardSelect.required = false;
            accountSelect.value = '';
            cardSelect.value = '';
        }
    });

    // Form submission
    document.getElementById('addTransactionForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = {
            type: document.getElementById('type').value,
            amount: parseFloat(document.getElementById('amount').value),
            categoryId: parseInt(document.getElementById('categoryId').value),
            description: document.getElementById('description').value,
            transactionDate: document.getElementById('transactionDate').value,
            paymentMethod: document.getElementById('paymentMethod').value,
            accountId: document.getElementById('accountId').value ? parseInt(document.getElementById('accountId').value) : null,
            cardId: document.getElementById('cardId').value ? parseInt(document.getElementById('cardId').value) : null,
            memo: document.getElementById('memo').value
        };

        try {
            const response = await fetch('/api/v1/transactions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData),
                credentials: 'include'
            });

            if (response.ok) {
                alert('거래가 추가되었습니다.');
                window.location.href = '/ledger';
            } else {
                const error = await response.json();
                alert('거래 추가에 실패했습니다: ' + (error.message || '알 수 없는 오류'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('거래 추가 중 오류가 발생했습니다.');
        }
    });
</script>
</body>
</html>
